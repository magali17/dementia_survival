---
title: "Descriptive Analyses for Air Pollution & Dementia"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=F}
# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

knitr::opts_chunk$set(echo = F, cache=F, cache.comments = F, message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE   
                      )  

pacman::p_load(kableExtra, tidyverse, table1, lubridate,
               ggpubr, #stat_cor() for ggplot
               GGally, # ggpairs()
               ggmap, sf, ggspatial, cowplot #mapping...adding scales, N arrows
               )    
 
# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")

set.seed(1)

image_path <- file.path("..", "manuscript", "images")
 
# Load files 
source("functions.R")
sur_person <- readRDS(file.path("Data", "Output", "sur_person.rda"))
sur <- readRDS(file.path("Data", "Output", "sur.rda")) 
exclusion_table <- readRDS(file.path("Data", "Output", "exclusion_table.rda")) 

## mapping
lat_long_crs <- 4326  
m_crs <- 32148 #meters

monitoring_area <- readRDS(file.path("~", "OneDrive - UW", "Documents", "Post Doc", "Study Projects", "ACT TRAP MM", "1. Our Campaign",  "Our Campaign R", "Data", "Output", "GIS", "monitoring_area_shp.rda")) 
st_area <- read_sf(file.path("~", "OneDrive - UW", "Documents", "School", "PhD", "Dissertation", "GIS", "Shapefiles", "Study area", "Spatiotemporal", "st_area.shp")) #%>% st_transform(project_crs)

```

```{r}

# https://cran.r-project.org/web/packages/PRISMAstatement/vignettes/exclusionflowcharts.html 

pacman::p_load(PRISMAstatement)

# --> last row looks weird
# persons
flow_exclusions(
  incl_counts = exclusion_table$persons,
  total_label = "Full Cohort",
  incl_labels = exclusion_table$description[2:length(exclusion_table$description)],
  percent_of_total = T,
  format_args = list(big.mark  = ",")
  )

# person-years
flow_exclusions(
  incl_counts = exclusion_table$person_years,
  total_label = "Full Cohort",
  incl_labels = exclusion_table$description[2:length(exclusion_table$description)],
  percent_of_total = T,
  format_args = list(big.mark  = ",")
  )

```


```{r}
exclusion_table2 <- exclusion_table %>%
  mutate(persons_pct = round(persons/first(persons)*100),
         person_years_pct = round(person_years/first(person_years)*100),
         
         persons_pct_dropped = round(persons_dropped/first(persons)*100),
         person_years_pct_dropped = round(person_years_dropped/first(person_years)*100),
         
         persons = paste0(persons, " (", persons_pct, "%)"),
         persons_dropped = paste0(persons_dropped, " (", persons_pct_dropped, "%)"),
         
         person_years = paste0(person_years, " (", person_years_pct, "%)"),
         person_years_dropped = paste0(person_years_dropped, " (", person_years_pct_dropped, "%)"),
         ) %>%
  select(description, persons, persons_dropped, person_years, person_years_dropped)

```

barplot 

```{r}
exclusion_table %>%
  filter(!grepl("2010", description)) %>%
  mutate(description = factor(description, levels = exclusion_table$description),
         person_years = person_years/1000
         ) %>%
  ggplot(aes(y=description, x=persons, fill=person_years)) + 
  geom_bar(stat="identity") + 
  scale_x_continuous(sec.axis = sec_axis(~ ./first(exclusion_table$persons),
                                         labels = scales::label_percent(), name = "Persons (%)"
                                         )) + 
  labs(x ="Persons (N)", fill = "Person-Years (1,000s)",
       y="")


```





Number of all-cause dementia cases if we restricted the study to other yaers

```{r}
sur_person %>%
  mutate(last_year = year(last_visit)) %>% 
  group_by(last_year) %>%
  summarize(dementia_cases = sum(corrected_anydementia)) %>%
  # ungroup() %>%
  # mutate(tot_dementia_cases = cumsum(dementia_cases)) %>%# View()
  
  ggplot(aes(x=last_year, y=dementia_cases)) +
  geom_bar(stat="identity")
  
  
lapply(c(1995, 2000, 2005, 2010, 2015), function(x) {
  sur_person %>%
    drop_na(apoe) %>%
    mutate(start_year = year(last_visit)) %>%
    group_by(start_year) %>%
    summarize(dementia_cases = sum(corrected_anydementia)) %>% #final_nindx
    filter(start_year >=x) %>%
    summarize(start_year = first(start_year),
              dementia_cases_remaining = sum(dementia_cases))
  }) %>%
  bind_rows() %>%
  mutate(prop = round(dementia_cases_remaining/max(dementia_cases_remaining), 2))


```



# Prediction Maps

```{r}
#make box little bigger than monitoring area
bbox <- st_bbox(st_transform(st_buffer(st_transform(st_area, m_crs), 40e3), lat_long_crs))
names(bbox) <- c("left", "bottom", "right", "top")
map0 <- suppressMessages(get_stamenmap(bbox = bbox, zoom = 11, #14, #11, 
                                       maptype = "toner-lite" #"terrain" #
                                       )) %>%
  ggmap(ggmap = ., darken = c(0.5, "white")) + theme_void()

```


```{r}
main_map <- map0 + 
  geom_sf(data=st_area, inherit.aes = F, aes(fill = "Spatiotemporal"), 
          alpha=0.1, lwd = 0.1,) + 
  geom_sf(data=monitoring_area, inherit.aes = F, aes(fill = "Mobile Monitoring"), 
          alpha=0.1, lwd = 0.1) +
  
  annotation_scale(location = "tl") +
  annotation_scale(location = "tl", unit_category ="imperial", pad_y = unit(0.55, "cm")) +
  annotation_north_arrow(location = "tl", which_north = "true", pad_y = unit(0.5, "in"),
                           style = north_arrow_fancy_orienteering) +
  theme_bw() +
  theme(
    legend.justification=c(1,1),  
    legend.position=c(1,1),  
    legend.background =  element_blank()
    ) +
    coord_sf(expand = F) +
  #add attribution/reference to bottom left
    geom_text(aes(x=-Inf, y=-Inf, hjust=-0.01, vjust=-0.3, 
                  label= "Map tiles by Stamen Design, under CC BY 3.0. \nData by OpenStreetMap, under ODbL."), size=2.5) +
  labs(x = "Longitude",
       y = "Latitude",
       fill = "Prediction Area"
       ) 

# inste map 
# example code: https://geocompr.github.io/post/2019/ggplot2-inset-maps/ 

data("us_states", package = "spData")

wa_map <- us_states %>%
  filter(NAME == "Washington") %>%
  st_transform(lat_long_crs)

wa_centroid <- st_coordinates(st_centroid(wa_map))

inset_map <- ggplot() + 
  geom_sf(data=wa_map, fill = "white", alpha=0.5) + 
  geom_sf(data=st_area, aes(fill = "Spatiotemporal"), lwd = 0.1, alpha = 0.2, show.legend = F) +
  geom_sf(data=monitoring_area, aes(fill = "Mobile Monitoring"), lwd = 0.1, alpha = 0.2, show.legend = F) +
  theme_void() + 
  #add "WA" label
  geom_text(aes(x = wa_centroid[1], y = wa_centroid[2]), label = "WA", size=4)
  
# combine using cowplot
ggdraw() +
  draw_plot(main_map) +
  draw_plot(inset_map, 
            # The dist along a (0,1) x- or y- axis to draw the left/bottom edge of the plot
            x = 0.65, y = 0.005, 
            # The width and height of the plot as proportion of the entire ggdraw object
            width = 0.23, height = 0.23)

ggsave(file.path(image_path, "SI", "monitoring_map.jpg"), width = 6, height = 8)

```

 
# Exposure Quality 

* **results are for 10 year exposure window from the MM model for the first pollutant listed**

* exp_wks_coverage, imp_quality, exact_coverage, and imputed_coverage

**exp_wks_coverage**.  
* Proportion of weeks of desired pollutant exposure with nonmissing location/pollutant info
* for MM and ST regions.
    * MM is slightly smaller for PM2.5 and NO2, as we would expect 
* the imputation quality and exact coverage variables are related to ALL of the known address histories, an Not necessarily the address histories that get used in the exposure models. Meaning that they are more useful/better indicators of the quality of the predictions when exposure coverage is high (e.g., 1.0), and less helpful if exposure coverage is low
* Amanda: "if coverage is low I would expect those rows to be excluded anyway.  If the coverage is low then your exposure for that row will have a really different error structure from exposure windows where coverage is high. In general, for most analyses in e.g. MESA, we exclude any rows where coverage is < 95%." 

**imp_qual10_yr_**.  
* Maximum imputation quality of the locations that fall in the relevant period of interest  
* people without valid addresses in the ST modeing region will have NAs     


```{r, results = "asis"}
indicator_variables <- c("exp_wks_coverage10_yr_MM",
                         "exact_coverage10_yr_MM",
                         "imputed_coverage10_yr_MM"#, "imp_qual10_yr_MM"
                         )
lapply(indicator_variables, function(x) {
  t <- filter(sur, 
       pollutant == first(pollutant),
       model == "MM",
       exposure_duration ==10
       ) %>%  
  summary_table(var = x) %>%
  kable(caption = paste("distribution of", x), digits = 3) %>%
  kable_styling()
  
  print(t)
  cat("\n")
})


filter(sur, 
       pollutant == first(pollutant),
       model == "MM",
       exposure_duration ==10
       ) %>%
  summarize(
    n = n(),
    imp0 = mean(imp_qual10_yr_MM==0),
    imp1 = mean(imp_qual10_yr_MM==1),
    imp2 = mean(imp_qual10_yr_MM==2),
    ) %>%  
  kable(caption = "proportion of each imp_qual10_yr_MM value (0-2)", digits = 3) %>%
  kable_styling()
  
  

```


# Visit dates

first and last visit dates. 

```{r}
# this doesn't make sense for 2005+ cohort
#sur_person$intakedt %>% min() 

sur_person$last_visit %>% max() 

```


# IPW

* distribution of weights in sur_person

* could stratify by covariates

```{r}
sur_person %>%
  drop_na(model_wt) %>%
summary_table(., "model_wt") %>% 
  kable(caption = "distribution of IPW", digits = 2) %>%
  kable_styling()

print("persons with modelw weights > 2")
table(sur_person$model_wt>2)

```


# Exposure 

## Exposure Table

```{r}
sur %>%
  filter(exposure_duration==10) %>% select(-exposure_duration) %>%
  group_by(pollutant, #exposure_duration, 
           Model=model) %>%
  summary_table("pollutant_prediction") %>%
  mutate_at(vars(Min:Max), ~ifelse(grepl("ufp|bc", pollutant),
                                   format(., digits=0, scientific = F, big.mark = ","),
                                   format(., digits=2, scientific = F, big.mark = ",")
                                   )) %>%
  mutate_at(vars(N), ~format(., big.mark=",")) %>%
  label_pollutants() %>%
  select(-N) %>%
  kable(caption = "Distribution of 10-year average pollutant predictions for the cohort (N=21,950 person-years)") %>%
  kable_styling()

```

## Exposure Boxplots

```{r}
 
sur %>%
  filter(exposure_duration ==10) %>%
  label_pollutants() %>%
  ggplot(aes(y=pollutant_prediction, x=pollutant, fill=model)) + 
  facet_wrap(~pollutant, scales="free") + 
  #geom_density(alpha=0.3)
  geom_boxplot() + 
  labs(x="", y="Pollutant Prediction", fill="Model", )
   
# ggsave(file.path(image_path, "SI", "exposure_boxplots.png"), height = 8, width = 8)
  
```


# Correlations

* note, not all rows have predictions for all pollutants b/c:
   * MM is dropped more often than ST b/c of low exp_wks_coverage

# --> why are MM and SP sometimes dropped but not ST? Don't SP and ST have the same spatial coverage? ask Roy's replacement to revert back to not using imp_quality, exact_coverage, and imputed_coverage separtely for MM and ST?

```{r}
cor_df <- sur %>%
  filter(exposure_duration==10) %>%
  label_pollutants() %>%
  mutate(#pollutant = gsub(" ", "\n", pollutant),
         pollutant = paste(pollutant, model)
         ) %>% 
  select(study_id, exposure_year,  pollutant,  pollutant_prediction,
         exp_wks_coverage10_yr_MM
         ) %>% 
  spread(pollutant, pollutant_prediction) %>% 
  select(contains(c(#"PNC", 
                    "NanoScan",
                    "BC", "NO2", "PM2.5"))) %>% 
  # not all rows have predictions for all pollutants b/c MM is dropped more often than ST due to low exp_wks_coverage
  
  # --> why are MM and SP sometimes dropped but not ST? Don't SP and ST have the same spatial coverage?
  
  drop_na() 


```

## table

```{r}

cor(cor_df, method = "pearson") %>%
  kable(caption = "10-year pollutant prediction correlations", digits = 2) %>%
  kable_styling()

```

 
## all pollutant 2D histogram
 
* MM PNC correlates better with SP PM2.5 than MM PM2.5. Is this b/c our PM2.5 measurements are unreliable?   
* similar for PNC vs MM NO2 and SP No2   

* MM NO2 is well correlated with ST NO2 b/c there is a positive relationship, even though the y-distribution is larger than with SP?
* MM BC is better correlated with MM PmM.25 than SP PM2.5 (good)

```{r}

cor(cor_df) %>%
  as.data.frame() %>%
  mutate_all(~round(.,2)) %>%
  rownames_to_column() %>%
  pivot_longer(cols = -rowname) %>%
  
  ggplot(aes(x=rowname, y=name, fill=value)) + 
  geom_bin2d() + # was geom_bin_2d() + 
  geom_text(aes(label=value)) + 
  scale_fill_gradient2(
  low = "red",
  mid = "white",
  high = "green",
  midpoint = 0.5) +
  theme(axis.text.x = element_text(angle = 30, #vjust = 0.5, 
                                   hjust=1)) + 
  labs(x="", y="", fill="R")

#ggsave(file.path(image_path, "SI", "correlations.png"), height = 8, width = 8)
  
```


## PM2.5 & NO2 scatterplot

```{r}
print("Comparison of 10 year exposure predictions from MM and ST models")

sur %>%
  filter(exposure_duration==10) %>%
  label_pollutants() %>%
  select(study_id, exposure_year,  model, pollutant,  pollutant_prediction) %>% 
  pivot_wider(names_from = model, values_from = pollutant_prediction) %>%
  pivot_longer(cols = c(SP, ST),  names_to = "ST_model", values_to="ST_value") %>%
  drop_na() %>%
  
  ggplot(aes(x=MM, y=ST_value, col=ST_model)) + 
  facet_wrap_equal(ST_model~pollutant, scales="free") +
  geom_point(alpha=0.01, shape=21) +
  geom_smooth() + 
  geom_abline(slope = 1, intercept = 0, alpha=0.5, linetype=2) +
  theme(aspect.ratio=1) +
  #add pearson correlation
  # --> doesn't work to only show r 
  stat_cor(aes(#label = ..r.label..
    )) + 

  labs(
    x = "Mobile Monitoring Prediction",
    y = "Spatio-Temporal Prediction"
  )

#ggsave(file.path(image_path, "SI", "no2_pm25_comparisons.png"), height = 8, width = 8)


```




# Table 1
 
 
```{r}
#calculate whether individuals were above/below 10-year avg MM pollutant concentration at baseline
baseline_conc_avg <- sur %>%
  filter(exposure_duration==10,
         model== "MM",
         pollutant %in% c("ufp_10_42", "bc", "no2"#, "pm25"
                          )) %>%
  group_by(study_id) %>%
  filter(exposure_year==first(exposure_year)) %>% 
  group_by(pollutant, exposure_year) %>%
  mutate(
    mean_baseline_conc = mean(pollutant_prediction),
    above_average = pollutant_prediction >= mean_baseline_conc) %>%
  ungroup() %>% 
  select(study_id, exposure_year, pollutant, pollutant_prediction, above_average) %>%
  pivot_wider(names_from = pollutant, values_from = c(pollutant_prediction, above_average))

sur_person_t1 <- left_join(sur_person, baseline_conc_avg) %>%
  mutate(apoe_available = !is.na(apoe))

```


```{r}
# Table1 tutorials: 
## https://cran.r-project.org/web/packages/table1/table1.pdf 
## https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html

# # round statistics
# my.render.cont <- function(x) {
#     with(stats.apply.rounding(stats.default(x), digits=2), c("",
#         "Mean (SD)"=sprintf("%s (%s)", MEAN, SD)))
# }
# my.render.cat <- function(x) {
#     c("", sapply(stats.default(x), function(y) with(y,
#         sprintf("%d (%0.0f%%)", FREQ, PCT))))
# }

  
t1_labels <- list(
  labels = list(
    male = "Sex",
    intakeage = "Age at Intake",
    follow_up_years = "Follow-Up Years",
    corrected_anydementia = "All-Cause Dementia Cases",
    ad_nincds = "Alzheimer's Disease Dementia Cases",
    vad_dementia = "Vascular Dementia",
    mixed_dementia = "Mixed Dementia",
    other_dementia = "Other Dementia",
    non_ad_dementia = "Non Alzheimer's Disease Dementia Cases",
    birth_cohort = "Birth Cohort",
    race_white = "Race",
    degree = "Degree",
    income_cat = "2,000 Census Tract Income at Baseline",
    apoe = "APOE e4 Allele",
    apoe_available = "Included in Main Analysis",
    model_wt = "IPW for Modeling Cohort",
    above_avg_ufp_10_42 = "Above Avg (PNC)",
    pollutant_prediction_ufp_10_42 = "PNC (pt/cm3)",
    pollutant_prediction_no2 = "NO2 (ppb)",
    pollutant_prediction_bc = "BC (ng/m3)" #,  pollutant_prediction_pm25 = "PM2.5 (ug/m3)"
    ),
  units = list(
    intakeage = "Years"
     ),
  categoricals = list(
    male = list('1' = "Male",
                '0' = "Female"),
    corrected_anydementia = list('1' = "Yes",
                                 '0' = "No"),
    vad_dementia = list('1' = "Yes", 
                        '0' = "No"),
    mixed_dementia = list('1' = "Yes", 
                        '0' = "No"),
    other_dementia = list('1' = "Yes", 
                        '0' = "No"),
    non_ad_dementia = list('1' = "Yes", 
                        '0' = "No"),
    ad_nincds = list('1' = "Yes",
                     '0' = "No"
                                 ),
    birth_cohort = list(sort(unique(sur_person$birth_cohort))),
    race_white = list('1' = "White",
                      '0' = "Non-White"),
    degree = list('0' = "None",
                  '1' = "GED/High School",
                  '3' = "Bachelor's",
                  '4' = "Master's",
                  '5' = "Doctorate",
                  '6' = "Other"),
    income_cat = list('1' = "<$35,000",
                      '2' = "$35,000 - <$50,000",
                      '3' = "$50,000 - <$75,000",
                      '4' = ">$75,000"),
    apoe = list('1' = "Carriers",
                '0' = "Non-Carriers"),
    apoe_available = list('TRUE' = "Included in Main Analysis",
                          'FALSE' = "Not Included in Main Analysis"),
    above_average_ufp_10_42 = list('FALSE' = "Below Avg (PNC)",
                                   'TRUE' = "Above Avg (PNC)")
    )#, groups=list("", "PNC Conc", "")
  
  ) 

print("Baseline cohort characteristics stratified by whether 10-year average PNC concentration at baseline was below or above that year's average.")
# Main Table 1
t1read(filter(sur_person_t1, apoe_available==TRUE), t1_labels) %>%
  table1(~intakeage + follow_up_years + male + race_white +degree + income_cat + apoe + model_wt + #birth_cohort + 
           corrected_anydementia + ad_nincds + non_ad_dementia + #vad_dementia + mixed_dementia + other_dementia + 
           pollutant_prediction_ufp_10_42 + pollutant_prediction_no2 + pollutant_prediction_bc #+ pollutant_prediction_pm25 
         |above_average_ufp_10_42 , data=., 
         #groupspan=c(1,2,1)
         # render.continuous = my.render.cont,
         # render.categorical = my.render.cat
         )

#cat("\n")

# # SI, by APOE STATUS/who is in the mode
# t1read(sur_person_t1, t1_labels) %>%
#   table1(~intakeage + follow_up_years + male + race_white +degree + income_cat + apoe + model_wt + birth_cohort + corrected_anydementia + ad_nincds + pollutant_prediction_ufp_10_42 + pollutant_prediction_no2 + pollutant_prediction_bc + pollutant_prediction_pm25 | apoe_available, data=., )

```


## Event ties

There were 85 dementia ties for the following models:  

* the specific exposures used to calculate this doesn't matter b/c ties happen on the age-scale regardless of the exposure assigned

```{r}
sur %>%
  filter(!is.na(apoe),
         model==first(model),
         exposure_duration == first(exposure_duration),
         pollutant==first(pollutant),
         dementia_now==1
         ) %>%  
  group_by(age_end_exposure) %>%
  summarize(N = n()) %>%
  filter(N >1) %>%
  distinct() %>% 
  summarize(event_ties = n()) 
  
```



 
