---
title: "Descriptive Analyses for Air Pollution & Dementia"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=F}
# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

knitr::opts_chunk$set(echo = F, cache=F, cache.comments = F, message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE #, fig.height = 8, fig.width = 8
                      )  

pacman::p_load(kableExtra, tidyverse)    
 
# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")

set.seed(1)

image_path <- file.path("..", "manuscript", "images")

# Load files 
source("0_functions.R")
sur <- readRDS(file.path("Data", "Output", "sur.rda"))
sur_person <- readRDS(file.path("Data", "Output", "sur_person.rda"))

```

# Intake date

# --> why is sur0 "2018-09-27" and sur "2017-08-01"?

```{r}


```




# Missingness

## exposure predictions

```{r}


```

## Imputed 

* Maximum imputation quality of the locations that fall in the relevant period of interest    
* people without valid addresses in the ST modeing region will have NAs  

# --> just ST region? is this why ST has estimates for e.g., BC, ufp?

```{r}
sur %>%
  select(pollutant, exposure_year, imp_qual10_yr, exp_avg10_yr_MM, exp_avg10_yr_ST) %>%
  pivot_longer(cols = contains("exp_avg"), names_to = "exposure", values_to = "value") %>%
  drop_na(imp_qual10_yr) %>%
  group_by(pollutant, exposure) %>%
  summarize(
    n = n(),
    imp0 = mean(imp_qual10_yr==0),
    imp1 = mean(imp_qual10_yr==1),
    imp2 = mean(imp_qual10_yr==2),
    )


# imp_quality is same for MM & st??
# sur %>% filter(study_id==1001) %>% select(exposure_year, pollutant, contains("exp_avg"), contains("imp_qual")) %>% View()


```

## Coverage 
* Proportion of weeks of desired pollutant exposure with nonmissing location/pollutant info 
* for MM and ST

#--> aero coverage? do these have pollutant estimates?

```{r}
sur %>%
  select(pollutant, exposure_year, exp_wks_coverage10_yr_MM, exp_wks_coverage10_yr_ST) %>%
  pivot_longer(cols = contains("coverage"), names_to = "coverage", values_to = "value") %>%
  drop_na(value) %>%  
  group_by(coverage, pollutant) %>%
  summarize(
    n = n(),
    min = min(value),
    mean = mean(value),
    median = median(value),
    max = max(value)
    )
   
```

exact_coverage

```{r}
sur %>%
  select(pollutant, exposure_year, exact_coverage10_yr) %>%
  drop_na(exact_coverage10_yr) %>%  
  group_by(pollutant) %>%
  summarize(
    n = n(),
    min = min(exact_coverage10_yr),
    mean = mean(exact_coverage10_yr),
    median = median(exact_coverage10_yr),
    max = max(exact_coverage10_yr)
    )
```

imputed_coverage

```{r}
sur %>%
  select(pollutant, exposure_year, imputed_coverage10_yr) %>%
  drop_na(imputed_coverage10_yr) %>%  
  group_by(pollutant) %>%
  summarize(
    n = n(),
    min = min(imputed_coverage10_yr),
    mean = mean(imputed_coverage10_yr),
    median = median(imputed_coverage10_yr),
    max = max(imputed_coverage10_yr)
    )

```



# IPW

* distribution of weights in sur_person

```{r}

```


# Location & Prediction Quality

```{r}

```


# Exposure from different models

```{r}

```



# Event ties

```{r}

```



# Table 1

```{r}

```






# SI

## DAG

https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html
```{r}
# smoking_ca_dag <- dagify(cardiacarrest ~ cholesterol,
#        cholesterol ~ smoking + weight,
#        smoking ~ unhealthy,
#        weight ~ unhealthy,
#        labels = c("cardiacarrest" = "Cardiac\n Arrest", 
#                   "smoking" = "Smoking",
#                   "cholesterol" = "Cholesterol",
#                   "unhealthy" = "Unhealthy\n Lifestyle",
#                   "weight" = "Weight"),
#        latent = "unhealthy",
#        exposure = "smoking",
#        outcome = "cardiacarrest")
# 
# ggdag(smoking_ca_dag, text = FALSE, use_labels = "label")

```


```{r}
pacman::p_load(dagitty, ggdag)
# theme_set(theme_dag())

sur_dag <-ggdag::dagify(dementia~trap,
                  
                  outcome = "dementia",
                  exposure = "trap",
                  labels = c("trap" = "TRAP")
                  
                  ) 

ggdag(sur_dag, text=T, use_labels = "label") + 
  theme_dag()

```


