---
title: "Descriptive Analyses for Air Pollution & Dementia"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=F}
# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

knitr::opts_chunk$set(echo = F, cache=F, cache.comments = F, message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE #, fig.height = 8, fig.width = 8
                      )  

pacman::p_load(kableExtra, tidyverse,
               #DAGs
               dagitty, ggdag
               )    
 
# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")

set.seed(1)

image_path <- file.path("..", "manuscript", "images")

# Load files 
source("0_functions.R")
sur <- readRDS(file.path("Data", "Output", "sur.rda"))
sur_person <- readRDS(file.path("Data", "Output", "sur_person.rda"))

```

# Intake date

# --> why is sur0 "2018-09-27" and sur "2017-08-01"?

```{r}


```




# Missingness

## exposure predictions

```{r}


```

## Imputed 

* Maximum imputation quality of the locations that fall in the relevant period of interest    
* people without valid addresses in the ST modeing region will have NAs  

# --> just ST region? is this why ST has estimates for e.g., BC, ufp?

```{r}
sur %>%
  select(pollutant, exposure_year, imp_qual10_yr, exp_avg10_yr_MM, exp_avg10_yr_ST) %>%
  pivot_longer(cols = contains("exp_avg"), names_to = "exposure", values_to = "value") %>%
  drop_na(imp_qual10_yr) %>%
  group_by(pollutant, exposure) %>%
  summarize(
    n = n(),
    imp0 = mean(imp_qual10_yr==0),
    imp1 = mean(imp_qual10_yr==1),
    imp2 = mean(imp_qual10_yr==2),
    )


# imp_quality is same for MM & st??
# sur %>% filter(study_id==1001) %>% select(exposure_year, pollutant, contains("exp_avg"), contains("imp_qual")) %>% View()


```

## Coverage 
* Proportion of weeks of desired pollutant exposure with nonmissing location/pollutant info 
* for MM and ST

#--> aero coverage? do these have pollutant estimates?

```{r}
sur %>%
  select(pollutant, exposure_year, exp_wks_coverage10_yr_MM, exp_wks_coverage10_yr_ST) %>%
  pivot_longer(cols = contains("coverage"), names_to = "coverage", values_to = "value") %>%
  drop_na(value) %>%  
  group_by(coverage, pollutant) %>%
  summarize(
    n = n(),
    min = min(value),
    mean = mean(value),
    median = median(value),
    max = max(value)
    )
   
```

exact_coverage

```{r}
sur %>%
  select(pollutant, exposure_year, exact_coverage10_yr) %>%
  drop_na(exact_coverage10_yr) %>%  
  group_by(pollutant) %>%
  summarize(
    n = n(),
    min = min(exact_coverage10_yr),
    mean = mean(exact_coverage10_yr),
    median = median(exact_coverage10_yr),
    max = max(exact_coverage10_yr)
    )
```

imputed_coverage

```{r}
sur %>%
  select(pollutant, exposure_year, imputed_coverage10_yr) %>%
  drop_na(imputed_coverage10_yr) %>%  
  group_by(pollutant) %>%
  summarize(
    n = n(),
    min = min(imputed_coverage10_yr),
    mean = mean(imputed_coverage10_yr),
    median = median(imputed_coverage10_yr),
    max = max(imputed_coverage10_yr)
    )

```



# IPW

* distribution of weights in sur_person

```{r}

```


# Location & Prediction Quality

```{r}

```


# Exposure from different models

```{r}

```



# Event ties

```{r}

```



# Table 1

```{r}

```






# SI

## DAG

https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html
 
# --> should there not be an arrow from trap --> dementia? 

```{r}
 
# theme_set(theme_dag())
dag_labels <- c("dementia" = "DEMENTIA",
                             "trap" = "TRAP",
                             "bmi" = "BMI",
                             "cv_health" = "Cardiovascular\nHealth",
                             "smoking" ="Smoking",
                             "sur_65" = "Survival\nto ≥65yr",
                             "apoe" = "APOE",
                             "sex" = "Sex",
                             "phys_activity" = "Physical\nActivity",
                             "year" = "Year",
                             "ses" = "SES"
                             )

sur_dag_full <-dagify(dementia~trap+bmi+cv_health+smoking+sur_65+apoe+sex+phys_activity+year+ses,
                        trap~ses+year+phys_activity,
                        bmi~trap,
                        cv_health~bmi+trap+phys_activity+sex+smoking,
                        smoking~ses,
                        sur_65~smoking+cv_health+bmi+trap+ses+year+phys_activity+sex,
                        phys_activity~sex,
                        outcome = "dementia",
                        exposure = "trap",
                        labels = dag_labels)

sur_dag_simple <-dagify(dementia~trap+sur_65+apoe+sex+year+ses,
                               trap~ses+year,
                               sur_65~trap+ses+year+sex,
                               outcome = "dementia",
                                exposure = "trap",
                               labels = dag_labels) 


final_dag <- sur_dag_full

```

adjusting for colliders and mediators can introduce bias. Instead, we’ll look at minimally sufficient adjustment sets: sets of covariates that, when adjusted for, block all back-door paths, but include no more or no less than necessary. 

```{r}
#simple dag
ggdag(final_dag, text=F, use_labels = "label") + theme_dag()
ggsave(file.path(image_path, "SI", "simple_dag.png"), width = 10, height = 6)

#adjustment dag
ggdag_adjustment_set(final_dag, #text=F, use_labels = "label", 
                     shadow=T,
                     text_size = 2) +
  theme_dag()
ggsave(file.path(image_path, "SI", "adjustment_dag.png"), width = 10, height = 6)


```

*Variables are d-connected if there are any active paths between them and d-separated if there are no open paths between them 

* are paths are active or deactive


# --> why are trap-dementia d-connected? the way we coded this?

```{r}
sur_dag_full2 <-dagify(dementia~bmi+cv_health+smoking+sur_65+apoe+sex+phys_activity+year+ses,
                        trap~ses+year+phys_activity,
                        bmi~trap,
                        cv_health~bmi+trap+phys_activity+sex+smoking,
                        smoking~ses,
                       # --> don't inlcude year? although life expectancy increases over time
                       sur_65~smoking+cv_health+bmi+trap+ses+phys_activity+sex+year,
                        phys_activity~sex,
                        outcome = "dementia",
                        exposure = "trap",
                        labels = dag_labels)


# d-relationship
ggdag_drelationship(sur_dag_full2,  
                    text_size = 2,
                    #text=F, use_labels = "label",  
                    controlling_for = c("ses", "apoe", "year", "sex", "sur_65", "phys_activity"
                                        )) + 
  theme_dag()
ggsave(file.path(image_path, "SI", "relationship_dag.png"), width = 10, height = 6)


```

